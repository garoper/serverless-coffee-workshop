+++
title = "Testing Asynchronous Services"
weight = 14
+++

For asynchronous testing we will be introducing the concept of a test harness which is registered as a receiver of asynchronous events. This can then be used for automated inspection that an event or a sequence of events occurred without having to parse thru Amazon CloudWatch logs or run a test case multiple times to ensure a sampling is collected based on the configured sampling rule for AWS X-Ray.

The test harness consists of AWS Lambda functions that writes to an AWS DynamoDB table. The DynamoDB table serves as a central log of all asynchronous events.

## AWS EventBridge Test Harness ##
The Lambda function we will be working with is written to capture AWS EventBridge events. We will be instrumenting it to capture the EventBridge event generated by  `config-service` Lambda function when a change has been made to `serverlesspresso-config-table`.

1. Navigate to `~/environment/serverlesspresso/setup` and re-run the `sam deploy --guided`. Ensure the to **DeployTestResources** prompt is **True**. This will ensure the test harness is deployed. 

2. We will be updating the `~/environment/serverlesspresso/setup/template.yaml` to programatically add the ConfigService event pattern to trigger our test harness. Locate the `TestHarnessFunction`. How should the below code block be added to the file?

```code
      Events:
        TriggerValidator:
          Type: EventBridgeRule
          Properties:
            EventBusName: "Serverlesspresso"
            Pattern:
              source:
                - !Ref Source
              detail-type:
                - prefix: 'ConfigService.'
```

## Testing ##
We will be using the test case used in the previous synchronous test to trigger the asynchronous events. 

1. Navigate to the `config-service`
```
cd ~/environment/serverlesspresso/backends/2-config-service/code
```
2. We will be running the `integrationTest.js` file using the Mocha framework. We will use the `npx` command to ensure the locally installed modules are accessed without having to modify the PATH variable.
```
npx mocha integrationTest.js
